---
kind: Workflow
metadata:
  generateName: indonesia-coastlines-
  namespace: argo-workflows
spec:
  serviceAccountName: argo-workflows-executor
  entrypoint: coastlines-dag
  parallelism: 120
  podGC:
    strategy: OnPodSuccess
    deleteDelayDuration: 120s
  podMetadata:
    annotations:
      karpenter.sh/do-not-disrupt: 'true'
  nodeSelector:
    data-production: r8xlarge
  tolerations:
    - key: data-production
      operator: Equal
      value: r8xlarge
      effect: NoSchedule
  workflowMetadata:
    labels:
      app: indonesia-coastlines
  arguments:
    parameters:
      - name: image-tag
        value: "0.0.3-4-g2b9a792"
      - name: result-version
        value: "0.0.5"
      - name: tiles-subset
        value: '[\"103,21\"]' # Can be [] for all tiles or '[\"1965,62\",\"1953,69\"]'
        # value: '[]'
      - name: config
        value: "https://raw.githubusercontent.com/piksel-ina/indonesia-coastlines/refs/heads/main/configs/indonesia_coastlines_config_mndwi_nir_25.yaml"
      - name: overwrite
        value: "--no-overwrite"
  templates:
    - name: coastlines-dag
      dag:
        tasks:
          - name: generate-ids
            template: generate
            arguments:
              parameters:
                - name: config
                  value: "{{workflow.parameters.config}}"
                - name: tiles-subset
                  value: "{{workflow.parameters.tiles-subset}}"

          - name: process-id
            depends: generate-ids.Succeeded
            template: process
            withParam: "{{tasks.generate-ids.outputs.result}}"
            arguments:
              parameters:
                - name: id
                  value: "{{item}}"
                - name: config
                  value: "{{workflow.parameters.config}}"
                - name: result-version
                  value: "{{workflow.parameters.result-version}}"
                - name: overwrite
                  value: "{{workflow.parameters.overwrite}}"

          - name: merge
            depends: "process-id.AnySucceeded"
            template: merge-continental
            arguments:
              parameters:
                - name: config
                  value: "{{workflow.parameters.config}}"
                - name: result-version
                  value: "{{workflow.parameters.result-version}}"

    - name: generate
      inputs:
        parameters:
          - name: config
          - name: tiles-subset
      container:
        image: 686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/coastlines:{{workflow.parameters.image-tag}}
        command: [bash, -c]
        args:
          - >-
            coastlines-print-tiles
            --config-file {{inputs.parameters.config}}
            --config-type coastlines
            --tiles-subset "{{inputs.parameters.tiles-subset}}"

    - name: process
      metadata:
        labels:
          app: "argo-coastlines-process-{{workflow.name}}"
      inputs:
        parameters:
          - name: id
          - name: config
          - name: result-version
          - name: overwrite
      # retryStrategy:
      #   limit: 2
      #   retryPolicy: Always
      container:
        image: 686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/coastlines:{{workflow.parameters.image-tag}}
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            memory: 64Gi
            cpu: 8.0
          limits:
            cpu: 12.0
            memory: 80Gi
        command: [bash, -c]
        args:
          - |
            set -xe

            echo "Downloading tide model"
            wget -qq https://s3.ap-southeast-3.amazonaws.com/piksel-staging-public-data/ls_coastlines/indo_tide_models.zip \
              -O /tmp/tide_models.zip && \
            unzip -qq /tmp/tide_models.zip -d /tmp/tide_models_temp &&
            mv /tmp/tide_models_temp /tmp/tide_models

            echo "Running coastlines"
            coastlines-combined \
              --config-path={{inputs.parameters.config}} \
              --study-area={{inputs.parameters.id}} \
              --tide-data-location="/tmp/tide_models/" \
              --output-version={{inputs.parameters.result-version}} \
              {{inputs.parameters.overwrite}}
        env:
          - name: ODC_DEFAULT_DB_HOSTNAME
            value: pg-proxy-service.database.svc.cluster.local
          - name: ODC_DEFAULT_DB_PORT
            value: '6432'
          - name: ODC_DEFAULT_DB_USERNAME
            valueFrom:
              secretKeyRef:
                name: odc
                key: username
          - name: ODC_DEFAULT_DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: odc
                key: password
          - name: ODC_DEFAULT_DB_DATABASE
            valueFrom:
              secretKeyRef:
                name: odc
                key: username
          - name: ODC_DEFAULT_INDEX_DRIVER
            value: postgis

    - name: merge-continental
      metadata:
        labels:
          app: "argo-coastlines-merge-{{workflow.name}}"
      inputs:
        parameters:
          - name: config
          - name: result-version
      container:
        image: 686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/coastlines:{{workflow.parameters.image-tag}}
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            memory: 32Gi
            cpu: 4.0
          limits:
            cpu: 8.0
            memory: 40Gi
        command: [bash, -c]
        args:
          - |
            coastlines-merge \
              --config-path={{inputs.parameters.config}} \
              --output-version={{inputs.parameters.result-version}}
